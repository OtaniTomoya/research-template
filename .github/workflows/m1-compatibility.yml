# .github/workflows/m1-compatibility.yml
name: M1 Macäº’æ›æ€§ãƒã‚§ãƒƒã‚¯

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'pyproject.toml'
      - 'uv.lock'
      - 'src/**/*.py'
      - '.github/workflows/m1-compatibility.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'pyproject.toml'
      - 'uv.lock'
      - 'src/**/*.py'
      - '.github/workflows/m1-compatibility.yml'
  schedule:
    # æ¯Žé€±æœˆæ›œæ—¥ã®åˆå‰9æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ
    - cron: '0 0 * * 1'

jobs:
  m1-compatibility:
    name: Apple Silicon (M1/M2) ãƒã‚§ãƒƒã‚¯
    runs-on: macos-14  # M1 Mac runner
    timeout-minutes: 20
    
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]
    
    steps:
    - name: ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±ã®è¡¨ç¤º
      run: |
        echo "## ðŸ–¥ï¸ ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **OS**: $(sw_vers -productName) $(sw_vers -productVersion)" >> $GITHUB_STEP_SUMMARY
        echo "- **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**: $(uname -m)" >> $GITHUB_STEP_SUMMARY
        echo "- **ãƒ—ãƒ­ã‚»ãƒƒã‚µ**: $(sysctl -n machdep.cpu.brand_string)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # è©³ç´°æƒ…å ±ã‚’ãƒ­ã‚°ã«å‡ºåŠ›
        system_profiler SPHardwareDataType
    
    - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
    
    - name: uvã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      uses: astral-sh/setup-uv@v4
      with:
        enable-cache: true
        cache-dependency-glob: "uv.lock"
    
    - name: Python ${{ matrix.python-version }} ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      run: |
        uv python install ${{ matrix.python-version }}
        echo "Python $(uv run python --version) ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã—ãŸ"
        
        # PythonãŒãƒã‚¤ãƒ†ã‚£ãƒ–arm64ã§å‹•ä½œã—ã¦ã„ã‚‹ã‹ç¢ºèª
        echo "## ðŸ Pythonç’°å¢ƒ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Pythonãƒãƒ¼ã‚¸ãƒ§ãƒ³**: $(uv run python --version)" >> $GITHUB_STEP_SUMMARY
        echo "- **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**: $(uv run python -c 'import platform; print(platform.machine())')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
    
    - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        echo "ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
        uv sync --all-groups
        
        # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ç¢ºèª
        echo "### ä¸»è¦ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ |" >> $GITHUB_STEP_SUMMARY
        echo "|------------|------------|" >> $GITHUB_STEP_SUMMARY
    
    - name: PyTorchã®äº’æ›æ€§ãƒã‚§ãƒƒã‚¯
      run: |
        echo "## ðŸ”¥ PyTorchäº’æ›æ€§ãƒã‚§ãƒƒã‚¯" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # PyTorchã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
        uv run python -c "
import torch
import sys

print(f'PyTorch version: {torch.__version__}')
print(f'MPS available: {torch.backends.mps.is_available()}')
print(f'MPS built: {torch.backends.mps.is_built()}')

# GitHub Summaryã«å‡ºåŠ›
with open(sys.argv[1], 'a') as f:
    f.write(f'| PyTorch | {torch.__version__} |\\n')
    f.write(f'| MPSå¯¾å¿œ | {\"âœ…\" if torch.backends.mps.is_available() else \"âŒ\"} |\\n')
" "$GITHUB_STEP_SUMMARY"
        
        # MPSãƒ‡ãƒã‚¤ã‚¹ã§ã®åŸºæœ¬çš„ãªæ“ä½œãƒ†ã‚¹ãƒˆ
        uv run python -c "
import torch

if torch.backends.mps.is_available():
    print('MPSãƒ‡ãƒã‚¤ã‚¹ãƒ†ã‚¹ãƒˆ...')
    device = torch.device('mps')
    
    # ãƒ†ãƒ³ã‚½ãƒ«ä½œæˆ
    x = torch.randn(100, 100, device=device)
    y = torch.randn(100, 100, device=device)
    
    # è¡Œåˆ—ç©
    z = torch.matmul(x, y)
    print(f'è¡Œåˆ—ç©ã®çµæžœã‚µã‚¤ã‚º: {z.shape}')
    
    # å‹¾é…è¨ˆç®—
    x.requires_grad = True
    z = (x ** 2).sum()
    z.backward()
    print(f'å‹¾é…è¨ˆç®—æˆåŠŸ: {x.grad is not None}')
    
    print('âœ… MPSãƒ‡ãƒã‚¤ã‚¹ãƒ†ã‚¹ãƒˆæˆåŠŸ')
else:
    print('âš ï¸ MPSãŒåˆ©ç”¨ã§ãã¾ã›ã‚“')
"
    
    - name: NumPy/SciPyã®äº’æ›æ€§ãƒã‚§ãƒƒã‚¯
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ”¢ æ•°å€¤è¨ˆç®—ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒã‚§ãƒƒã‚¯" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        uv run python -c "
import numpy as np
import scipy
import sys

print(f'NumPy version: {np.__version__}')
print(f'SciPy version: {scipy.__version__}')

# Accelerateãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®ä½¿ç”¨ç¢ºèª
config = np.show_config(mode='dicts')
if 'accelerate' in str(config).lower():
    print('âœ… Accelerateãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ä½¿ç”¨')
else:
    print('â„¹ï¸ Accelerateãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ä½¿ç”¨ã—ã¦ã„ãªã„å¯èƒ½æ€§')

# GitHub Summaryã«å‡ºåŠ›
with open(sys.argv[1], 'a') as f:
    f.write(f'| NumPy | {np.__version__} |\\n')
    f.write(f'| SciPy | {scipy.__version__} |\\n')

# ãƒ™ãƒ³ãƒãƒžãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆ
import time
size = 1000
A = np.random.rand(size, size)
B = np.random.rand(size, size)

start = time.time()
C = np.dot(A, B)
elapsed = time.time() - start

print(f'è¡Œåˆ—ç© ({size}x{size}) å®Ÿè¡Œæ™‚é–“: {elapsed:.3f}ç§’')
" "$GITHUB_STEP_SUMMARY"
    
    - name: æ©Ÿæ¢°å­¦ç¿’ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒã‚§ãƒƒã‚¯
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ¤– æ©Ÿæ¢°å­¦ç¿’ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒã‚§ãƒƒã‚¯" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # scikit-learn
        uv run python -c "
import sklearn
import sys

print(f'scikit-learn version: {sklearn.__version__}')

# OpenBLASã®ç¢ºèª
from sklearn._build_utils import get_blas_info
blas_info = get_blas_info()
print(f'BLASæƒ…å ±: {blas_info}')

with open(sys.argv[1], 'a') as f:
    f.write(f'| scikit-learn | {sklearn.__version__} |\\n')
" "$GITHUB_STEP_SUMMARY"
        
        # transformers
        uv run python -c "
try:
    import transformers
    print(f'transformers version: {transformers.__version__}')
    
    # åŸºæœ¬çš„ãªãƒ¢ãƒ‡ãƒ«ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆ
    from transformers import AutoTokenizer
    tokenizer = AutoTokenizer.from_pretrained('bert-base-uncased')
    print('âœ… Transformersã®åŸºæœ¬æ©Ÿèƒ½ç¢ºèª')
    
    import sys
    with open(sys.argv[1], 'a') as f:
        f.write(f'| transformers | {transformers.__version__} |\\n')
except Exception as e:
    print(f'âš ï¸ Transformersã®ãƒ†ã‚¹ãƒˆå¤±æ•—: {e}')
" "$GITHUB_STEP_SUMMARY"
    
    - name: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # ç°¡å˜ãªãƒ™ãƒ³ãƒãƒžãƒ¼ã‚¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
        cat > benchmark.py << 'EOF'
import time
import torch
import numpy as np
import sys

results = []

# NumPyãƒ†ã‚¹ãƒˆ
size = 2000
A = np.random.rand(size, size)
B = np.random.rand(size, size)

start = time.time()
C = np.dot(A, B)
numpy_time = time.time() - start
results.append(f"NumPyè¡Œåˆ—ç© ({size}x{size}): {numpy_time:.3f}ç§’")

# PyTorchãƒ†ã‚¹ãƒˆï¼ˆCPUï¼‰
A_torch = torch.randn(size, size)
B_torch = torch.randn(size, size)

start = time.time()
C_torch = torch.matmul(A_torch, B_torch)
torch_cpu_time = time.time() - start
results.append(f"PyTorch CPUè¡Œåˆ—ç©: {torch_cpu_time:.3f}ç§’")

# PyTorchãƒ†ã‚¹ãƒˆï¼ˆMPSï¼‰
if torch.backends.mps.is_available():
    A_mps = A_torch.to('mps')
    B_mps = B_torch.to('mps')
    
    # ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—
    torch.matmul(A_mps, B_mps)
    torch.mps.synchronize()
    
    start = time.time()
    C_mps = torch.matmul(A_mps, B_mps)
    torch.mps.synchronize()
    torch_mps_time = time.time() - start
    results.append(f"PyTorch MPSè¡Œåˆ—ç©: {torch_mps_time:.3f}ç§’")
    results.append(f"MPSé«˜é€ŸåŒ–: {torch_cpu_time/torch_mps_time:.2f}x")

# çµæžœã‚’GitHub Summaryã«å‡ºåŠ›
with open(sys.argv[1], 'a') as f:
    for result in results:
        f.write(f"- {result}\\n")
EOF
        
        uv run python benchmark.py "$GITHUB_STEP_SUMMARY"
    
    - name: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚³ãƒ¼ãƒ‰ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“¦ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        uv run python -c "
import sys
sys.path.insert(0, 'src')

try:
    # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    from ${PROJECT_NAME:-poi_recommendation_research}.utils.common import get_device
    device = get_device()
    print(f'æ¤œå‡ºã•ã‚ŒãŸãƒ‡ãƒã‚¤ã‚¹: {device}')
    
    with open(sys.argv[1], 'a') as f:
        f.write(f'âœ… ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆæˆåŠŸ\\n')
        f.write(f'- æ¤œå‡ºã•ã‚ŒãŸãƒ‡ãƒã‚¤ã‚¹: {device}\\n')
except Exception as e:
    print(f'âŒ ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: {e}')
    with open(sys.argv[1], 'a') as f:
        f.write(f'âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—: {e}\\n')
    sys.exit(1)
" "$GITHUB_STEP_SUMMARY"
    
    - name: ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ§ª ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        if uv run pytest tests/ -v --no-header --tb=short; then
          echo "âœ… ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã—ã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi
    
    - name: ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãƒã‚§ãƒƒã‚¯
      if: always()
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ’¾ ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨çŠ¶æ³" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # ãƒ¡ãƒ¢ãƒªä½¿ç”¨çŠ¶æ³
        vm_stat | grep -E "(free|active|inactive|wired|compressed)" | while read line; do
          echo "- $line" >> $GITHUB_STEP_SUMMARY
        done
        
        # ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨çŠ¶æ³
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨çŠ¶æ³" >> $GITHUB_STEP_SUMMARY
        df -h | grep -E "(Filesystem|/System/Volumes/Data)" >> $GITHUB_STEP_SUMMARY

  m1-notebook-test:
    name: M1 Notebookå®Ÿè¡Œãƒ†ã‚¹ãƒˆ
    runs-on: macos-14
    timeout-minutes: 15
    if: github.event_name == 'schedule' || contains(github.event.head_commit.message, '[m1-notebook]')
    
    steps:
    - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
    
    - name: uvã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      uses: astral-sh/setup-uv@v4
    
    - name: Pythonç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      run: |
        uv python install 3.11
        uv sync --group notebook
    
    - name: Notebookã®å®Ÿè¡Œãƒ†ã‚¹ãƒˆ
      run: |
        echo "## ðŸ““ Notebookå®Ÿè¡Œãƒ†ã‚¹ãƒˆ (M1)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # ç’°å¢ƒç¢ºèªç”¨ã®NotebookãŒã‚ã‚Œã°å®Ÿè¡Œ
        if [ -f "notebooks/01_exploratory/00_setup_check.ipynb" ]; then
          uv run jupyter execute notebooks/01_exploratory/00_setup_check.ipynb
          echo "âœ… ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç¢ºèªNotebookã®å®Ÿè¡ŒæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
        else
          echo "â„¹ï¸ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç¢ºèªNotebookãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" >> $GITHUB_STEP_SUMMARY
        fi