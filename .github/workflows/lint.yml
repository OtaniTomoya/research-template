# .github/workflows/lint.yml
name: ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened ]

# ä¸¦è¡Œå®Ÿè¡Œã®åˆ¶å¾¡
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint-and-format:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ã™ã¹ã¦ã®å±¥æ­´ã‚’å–å¾—ï¼ˆå·®åˆ†ãƒã‚§ãƒƒã‚¯ç”¨ï¼‰
    
    - name: uvã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      uses: astral-sh/setup-uv@v4
      with:
        enable-cache: true
        cache-dependency-glob: "uv.lock"
    
    - name: Pythonç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      run: |
        uv python install 3.11
        echo "Python $(uv run python --version) ã‚’ä½¿ç”¨"
    
    - name: é–‹ç™ºä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        uv sync --group dev
        
    - name: Ruffã«ã‚ˆã‚‹ãƒªãƒ³ãƒˆãƒã‚§ãƒƒã‚¯
      id: ruff-lint
      run: |
        echo "::group::Ruffãƒªãƒ³ãƒˆçµæžœ"
        uv run ruff check src/ tests/ scripts/ --output-format=github
        echo "::endgroup::"
      continue-on-error: true
    
    - name: Ruffã«ã‚ˆã‚‹ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆãƒã‚§ãƒƒã‚¯
      id: ruff-format
      run: |
        echo "::group::Ruffãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆçµæžœ"
        uv run ruff format --check src/ tests/ scripts/
        echo "::endgroup::"
      continue-on-error: true
    
    - name: Pyrightã«ã‚ˆã‚‹åž‹ãƒã‚§ãƒƒã‚¯
      id: pyright
      run: |
        echo "::group::Pyrightåž‹ãƒã‚§ãƒƒã‚¯çµæžœ"
        uv run pyright src/
        echo "::endgroup::"
      continue-on-error: true
    
    - name: çµæžœã‚µãƒžãƒªãƒ¼
      if: always()
      run: |
        echo "## ðŸ” ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯çµæžœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Ruffãƒªãƒ³ãƒˆ
        if [ "${{ steps.ruff-lint.outcome }}" == "success" ]; then
          echo "âœ… **Ruffãƒªãƒ³ãƒˆ**: ãƒ‘ã‚¹" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Ruffãƒªãƒ³ãƒˆ**: ã‚¨ãƒ©ãƒ¼ã‚ã‚Š" >> $GITHUB_STEP_SUMMARY
          echo "  \`uv run ruff check --fix\` ã§è‡ªå‹•ä¿®æ­£å¯èƒ½" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Ruffãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ
        if [ "${{ steps.ruff-format.outcome }}" == "success" ]; then
          echo "âœ… **Ruffãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ**: ãƒ‘ã‚¹" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Ruffãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ**: è¦ä¿®æ­£" >> $GITHUB_STEP_SUMMARY
          echo "  \`uv run ruff format\` ã§è‡ªå‹•ä¿®æ­£å¯èƒ½" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Pyright
        if [ "${{ steps.pyright.outcome }}" == "success" ]; then
          echo "âœ… **Pyrightåž‹ãƒã‚§ãƒƒã‚¯**: ãƒ‘ã‚¹" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸  **Pyrightåž‹ãƒã‚§ãƒƒã‚¯**: åž‹ã‚¨ãƒ©ãƒ¼ã‚ã‚Š" >> $GITHUB_STEP_SUMMARY
        fi
        
        # å…¨ä½“ã®çµæžœ
        if [ "${{ steps.ruff-lint.outcome }}" != "success" ] || \
           [ "${{ steps.ruff-format.outcome }}" != "success" ] || \
           [ "${{ steps.pyright.outcome }}" != "success" ]; then
          exit 1
        fi

  code-security:
    name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
    
    - name: uvã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      uses: astral-sh/setup-uv@v4
    
    - name: Pythonç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      run: uv python install 3.11
    
    - name: Banditã«ã‚ˆã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
      run: |
        uv tool run bandit -r src/ -f json -o bandit-report.json || true
        
    - name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆã®è§£æž
      if: always()
      run: |
        if [ -f bandit-report.json ]; then
          echo "## ðŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯çµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # JSONã‹ã‚‰å•é¡Œã®æ•°ã‚’æŠ½å‡º
          HIGH=$(jq '.metrics."SEVERITY.HIGH"' bandit-report.json)
          MEDIUM=$(jq '.metrics."SEVERITY.MEDIUM"' bandit-report.json)
          LOW=$(jq '.metrics."SEVERITY.LOW"' bandit-report.json)
          
          if [ "$HIGH" -eq 0 ] && [ "$MEDIUM" -eq 0 ]; then
            echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ:" >> $GITHUB_STEP_SUMMARY
            echo "- é«˜: $HIGH" >> $GITHUB_STEP_SUMMARY
            echo "- ä¸­: $MEDIUM" >> $GITHUB_STEP_SUMMARY
            echo "- ä½Ž: $LOW" >> $GITHUB_STEP_SUMMARY
          fi
        fi

  notebook-check:
    name: Notebookãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: contains(github.event.head_commit.message, '.ipynb') || github.event.pull_request.changed_files > 0
    
    steps:
    - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
    
    - name: uvã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      uses: astral-sh/setup-uv@v4
    
    - name: Pythonç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      run: |
        uv python install 3.11
        uv sync --group notebook
    
    - name: Notebookã®å‡ºåŠ›ãƒã‚§ãƒƒã‚¯
      run: |
        echo "## ðŸ““ Notebookãƒã‚§ãƒƒã‚¯" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # .ipynbãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
        notebooks=$(find notebooks -name "*.ipynb" -type f)
        
        if [ -z "$notebooks" ]; then
          echo "Notebookãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          exit 0
        fi
        
        # å„Notebookã‚’ãƒã‚§ãƒƒã‚¯
        has_output=false
        for nb in $notebooks; do
          # nbstripoutã§å‡ºåŠ›ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if ! uv run nbstripout --dry-run "$nb" > /dev/null 2>&1; then
            echo "âš ï¸ \`$nb\` ã«å‡ºåŠ›ãŒå«ã¾ã‚Œã¦ã„ã¾ã™" >> $GITHUB_STEP_SUMMARY
            has_output=true
          fi
        done
        
        if [ "$has_output" = false ]; then
          echo "âœ… ã™ã¹ã¦ã®Notebookã«å‡ºåŠ›ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“" >> $GITHUB_STEP_SUMMARY
        else
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ä¿®æ­£æ–¹æ³•**: \`uv run nbstripout notebooks/**/*.ipynb\`" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi

  dependencies-check:
    name: ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
    
    - name: uvã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      uses: astral-sh/setup-uv@v4
    
    - name: ä¾å­˜é–¢ä¿‚ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
      run: |
        echo "## ðŸ“¦ ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # uv.lockãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
        if [ ! -f "uv.lock" ]; then
          echo "âŒ uv.lockãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" >> $GITHUB_STEP_SUMMARY
          echo "  \`uv lock\` ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi
        
        # ä¾å­˜é–¢ä¿‚ã®åŒæœŸãƒã‚§ãƒƒã‚¯
        if uv sync --dry-run 2>&1 | grep -q "Would install"; then
          echo "âš ï¸ ä¾å­˜é–¢ä¿‚ãŒåŒæœŸã•ã‚Œã¦ã„ã¾ã›ã‚“" >> $GITHUB_STEP_SUMMARY
          echo "  \`uv sync\` ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„" >> $GITHUB_STEP_SUMMARY
          exit 1
        else
          echo "âœ… ä¾å­˜é–¢ä¿‚ã¯æœ€æ–°ã§ã™" >> $GITHUB_STEP_SUMMARY
        fi
        
        # è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯ï¼ˆpip-auditä½¿ç”¨ï¼‰
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯" >> $GITHUB_STEP_SUMMARY
        uv tool run pip-audit || echo "âš ï¸ è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY

  documentation-check:
    name: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
    
    - name: Markdownãƒªãƒ³ã‚¯ãƒã‚§ãƒƒã‚¯
      uses: gaurav-nelson/github-action-markdown-link-check@v1
      with:
        config-file: '.github/markdown-link-check.json'
        folder-path: 'docs'
        file-path: './README.md'
      continue-on-error: true
    
    - name: Docstringã‚«ãƒãƒ¬ãƒƒã‚¸ãƒã‚§ãƒƒã‚¯
      run: |
        echo "## ðŸ“š ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # interrogateãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
        if command -v interrogate &> /dev/null; then
          interrogate -vv src/ --generate-badge docs/
          echo "Docstringã‚«ãƒãƒ¬ãƒƒã‚¸ãƒãƒƒã‚¸ã‚’ç”Ÿæˆã—ã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
        else
          echo "â„¹ï¸ interrogateãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“" >> $GITHUB_STEP_SUMMARY
        fi